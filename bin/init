#!/usr/bin/env bash
cd $(dirname $(dirname $(readlink -f $0)))

if [ -d /mnt/databases ]
then
  chown app:app /mnt/databases

  mkdir -p /mnt/databases/db
  chown app:app /mnt/databases/db
  export RAILS_DB_VOLUME=/mnt/databases/db

  mkdir -p /mnt/databases/shorage
  chown app:app /mnt/databases/storage
  export RAILS_STORAGE=/mnt/databases/storage
fi

if [ ! -f ${RAILS_DB_VOLUME:=db}/htpasswd ]
then
  htpasswd -b -c ${RAILS_DB_VOLUME}/htpasswd bootstrap password
  chown app:app ${RAILS_DB_VOLUME}/htpasswd
fi

chown app:app /etc/nginx/sites-enabled
runuser -u app ruby config/tenant/nginx-config.rb
chown -R root:root /etc/nginx/sites-enabled

mkdir -p /var/run/dbus
dbus-daemon --system

/sbin/my_init
