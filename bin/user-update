#!/usr/bin/env ruby

if ENV['FLY_APP_NAME']
  # get a list of ip addresses for running instances
  addrs = 
    `dig +short -t aaaa global.#{ENV['FLY_APP_NAME']}.internal`.split

  # remove current region from the list
  addrs -=
    `dig +short -t aaaa #{ENV['FLY_REGION']}.#{ENV['FLY_APP_NAME']}.internal`.split

  # rsync htpasswd and index.sqlite3 to each instance
  addrs.each do |addr|
    system *(%W[
      rsync
      -av
      --update
      /data/db/htpasswd
    ] +
      Dir['db/index.sqlite3*'] +
    %W[
      rsync://[#{addr}]/data/db
    ])
  end
else
  if File.exist?('db/index.sqlite3.wal') && File.size('db/index.sqlite3.wal') > 0
    system "sqlite3 db/index.sqlite3 'PRAGMA wal_checkpoint(TRUNCATE); VACUUM;'"
  end

  system "sqlite3 db/index.sqlite3 'PRAGMA journal_mode=WAL;'"

  system *(%W[
    rsync
    -avv
    --update
    db/htpasswd
  ] +
    Dir['db/index.sqlite3*'] +
  %W[
    smooth:///data/db
  ])

  system "ssh smooth /rails/bin/user-update"
end
